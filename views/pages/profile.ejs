<!-- views/pages/profile.ejs -->
<%- include('../partials/header', { title: 'Profile' }) %>
<%- include('../partials/sidebar', { user: user, role: user.role }) %>


<style>
    .container {
        margin: auto; 
        width: 650px;
        padding: 20px;
    }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
        .container {
            margin-left: 0; 
            width: 100%;
        }
    }
    
</style>

<div class="dashboard-container container">
<div class="container mt-4">
    <h2>Profile</h2>

    <!-- Display Success or Error Messages for Profile Photo -->
    <div id="successMessage" class="alert alert-success" style="display: none;"></div>
    <div id="errorMessage" class="alert alert-danger" style="display: none;"></div>

    <!-- Display Success or Error Messages for Password Change -->
    <% if (successMessage) { %>
        <div class="alert alert-success">
            <%= successMessage %>
        </div>
    <% } %>
    <% if (errorMessage) { %>
        <div class="alert alert-danger">
            <%= errorMessage %>
        </div>
    <% } %>

    <!-- Display Profile Photo -->
    <div class="mb-4">
        <h4>Profile Photo</h4>
        <img src="<%= user.profilePhoto || 'https://via.placeholder.com/150' %>" id="profilePhotoDisplay" alt="Profile Photo" class="rounded-circle" width="150" height="150">

        <!-- AJAX form for photo upload -->
        <form id="uploadPhotoForm" enctype="multipart/form-data" class="mt-3">
            <div class="form-group">
                <label for="profilePhoto">Change Profile Photo</label>
                <input type="file" class="form-control" id="profilePhoto" name="profilePhoto" required>
            </div>
            <button type="submit" class="btn btn-primary">Upload Photo</button>
        </form>
    </div>

    <!-- Password Update Form -->
    <div>
        <h4>Change Password</h4>
        <form action="/profile/change-password" method="POST">
            <div class="form-group">
                <label for="currentPassword">Current Password</label>
                <input type="password" class="form-control" id="currentPassword" name="currentPassword" required>
            </div>
            <div class="form-group">
                <label for="newPassword">New Password</label>
                <input type="password" class="form-control" id="newPassword" name="newPassword" required>
            </div>
            <div class="form-group">
                <label for="confirmPassword">Confirm New Password</label>
                <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" required>
            </div>
            <button type="submit" class="btn btn-primary">Change Password</button>
        </form>
    </div>
</div>

<!-- Add AJAX for profile photo upload -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        $('#uploadPhotoForm').on('submit', function (e) {
            e.preventDefault(); // Prevent the form from submitting the default way

            var formData = new FormData(this);

            $.ajax({
                url: '/profile/upload-photo',
                type: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                success: function (data) {
                    $('#successMessage').text(data.successMessage).show();
                    $('#errorMessage').hide();

                    // Update the profile photo on the page
                    $('#profilePhotoDisplay').attr('src', data.profilePhoto);

                    // Update the profile photo in the navbar
                    $('nav .nav-link img').attr('src', data.profilePhoto);
                },
                error: function (xhr, status, error) {
                    $('#errorMessage').text('An error occurred: ' + xhr.responseText).show();
                    $('#successMessage').hide();
                }
            });
        });
    });
</script>

<%- include('../partials/footer') %>
</div>
